<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://hdqjl317.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://hdqjl317.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://hdqjl317.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="分布式系统"><link rel="canonical" href="https://hdqjl317.github.io/2022/10/04/computer-science/Simple-distributed/"><title>Simple_distributed - 计算机科学 | Caleb = = 加楽的小站</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Simple_distributed</h1><div class="meta"><span class="item" title="创建时间：2022-10-04 20:43:08"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-10-04T20:43:08+08:00">2022-10-04</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>27k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>24 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Caleb</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="/2022/10/04/computer-science/Simple-distributed/assets/fenbushixitong.png"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="分类于 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://hdqjl317.github.io/2022/10/04/computer-science/Simple-distributed/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Caleb"><meta itemprop="description" content="加楽的小站, 欢迎来到 Caleb 的个人博客!"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h2 id="服务注册"><a class="anchor" href="#服务注册">#</a> 服务注册</h2><p>服务进程是在注册中心注册自己的元数据信息，通常包括主机和端口号，有时还有身份验证信息，协议，版本号，以及运行环境的信息</p><p>本系统中包含了以下内容:</p><ol><li>创建 Web 服务</li><li>创建注册服务</li><li>注册 Web 服务</li><li>取消注册 Web 服务</li></ol><h3 id="创建日志服务"><a class="anchor" href="#创建日志服务">#</a> 创建日志服务</h3><p>在正式实现服务注册的功能之前，先实现日志服务，在项目文件夹下创建一个 log 文件夹，存放定义日志逻辑的代码</p><h4 id="编写日志服务逻辑"><a class="anchor" href="#编写日志服务逻辑">#</a> 编写日志服务逻辑</h4><p>日志服务是一个 WEB 服务，功能是接收 web 请求，将 POST 请求的内容写入到 log，注意这里对标准的 log 包起了别名 stdlog，因为后续要自定义一个 Logger 对象 log:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// log/server.go</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">package</span> log</pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"io/ioutil"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	stdlog <span class="token string">"log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token string">"os"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">var</span> log <span class="token operator">*</span>stdlog<span class="token punctuation">.</span>Logger</pre></td></tr><tr><td data-num="12"></td><td><pre> </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">type</span> fileLog <span class="token builtin">string</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>fl fileLog<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>fl<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err</pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre> </pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>destination <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	log <span class="token operator">=</span> stdlog<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token function">fileLog</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"go"</span><span class="token punctuation">,</span> stdlog<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre> </pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">func</span> <span class="token function">RegisterHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token keyword">switch</span> r<span class="token punctuation">.</span>Method <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		<span class="token keyword">case</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>  <span class="token comment">// 读取 Body 数据</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>				w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>				<span class="token keyword">return</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token function">write</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token keyword">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> </pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">func</span> <span class="token function">write</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v\n"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这段代码的作用是将日志写入文件系统，先为 filelog 实现 io.Writer 接口，定义 Write 方法</p><p>在这个方法中，首先调用了 OpenFile 方法，传入一个文件路径并返回一个 file 对象，指定了权限和模式，并随后判断是否产生错误，最后通过 io.Writer 接口写入文件:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>fl fileLog<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>fl<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span>  <span class="token comment">// 打开文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>接着定义 Run 函数，作用是将 log 指向某个文件路径，使用 log.New 来创建一个 Logger 对象，要传入的参数：写入的位置 (实现 io.Writer 接口)、日志前缀和日志内容的 flag (包含了日期和时间)</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>destination <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	log <span class="token operator">=</span> stdlog<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token function">fileLog</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"go"</span><span class="token punctuation">,</span> stdlog<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后注册一个 handler:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">RegisterHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token keyword">switch</span> r<span class="token punctuation">.</span>Method <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">case</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">:</span>  <span class="token comment">// POST 请求</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>				w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>				<span class="token keyword">return</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token function">write</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 写入数据</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token keyword">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用了一个 http.HandleFunc 来处理 HTTP 请求，使用 switch-case 结构判断请求方式来分支处理请求，如果是 POST 请求则调用 ioutil.ReadAll 读取 Body 数据，调用 write 函数 (之后实现) 写入文件，如果读取失败或者数据为空，则返回一个 BadRequest (400) 响应。如果接收到的请求不是 POST 请求，则返回一个 MethodNotAllowed 响应 (405)</p><p>如下是 write 函数:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">write</span><span class="token punctuation">(</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v\n"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>调用 log.Printf 就可以，这里的 log 是自定义的 Logger 对象 (已经在 Run 函数中创建)，路径在 New 方法中指定了，这时就会把日志信息写入所指向的文件中</p><h4 id="运行日志服务"><a class="anchor" href="#运行日志服务">#</a> 运行日志服务</h4><p>上述编写的 server.go 程序作为日志系统的后端，下面编写一段代码，将服务集中化管理，能够集中启动这些服务</p><p>创建一个 service 目录，并在其中编写 service.go 文件:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> service</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"context"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"log"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token builtin">string</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	registerHandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token function">registerHandlerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 注册请求处理函数</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	ctx <span class="token operator">=</span> <span class="token function">startService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>  <span class="token comment">// 启动服务</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">return</span> ctx<span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">func</span> <span class="token function">startService</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token builtin">string</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">var</span> srv http<span class="token punctuation">.</span>Server</pre></td></tr><tr><td data-num="20"></td><td><pre>	srv<span class="token punctuation">.</span>Addr <span class="token operator">=</span> <span class="token string">":"</span> <span class="token operator">+</span> port</pre></td></tr><tr><td data-num="21"></td><td><pre> </pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 监听 HTTP 请求 调用 ServeHTTP 方法</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre> </pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v started. Press any key to stop. \n"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token keyword">var</span> s <span class="token builtin">string</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Scanln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre> </pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token keyword">return</span> ctx</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这段代码定义了一个 Start 函数，接收 context 接口，服务名称，地址，端口号，作用是启动指定的服务，先调用了 registerHandleFunc 注册请求处理函数 (服务程序要有一个处理函数，来处理到来的 HTTP 请求)，随后调用了 startService 函数，结束时返回 context 和 nil</p><p>在 startService 函数中调用了 WithCancel，返回一个 context 子节点和一个取消函数，用于触发取消信号，之后调一个 goroutine 启动 HTTP 服务器监听在指定的端口，处理到来的 HTTP 请求，当用户输入按下任意建就会触发 Shutdown 方法关闭服务器，并且调用取消函数撤销掉 context:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">startService</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token builtin">string</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">var</span> srv http<span class="token punctuation">.</span>Server</pre></td></tr><tr><td data-num="4"></td><td><pre>	srv<span class="token punctuation">.</span>Addr <span class="token operator">=</span> <span class="token string">":"</span> <span class="token operator">+</span> port</pre></td></tr><tr><td data-num="5"></td><td><pre> </pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v started. Press any key to stop. \n"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">var</span> s <span class="token builtin">string</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Scanln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>  <span class="token comment">// 关闭服务器</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">// 取消 context</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre> </pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">return</span> ctx</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建一个 cmd 文件夹，编写 main.go 作为整个程序的入口:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> main</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"context"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"distributed/log"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"distributed/service"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	stdlog <span class="token string">"log"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	log<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"./distributed.log"</span><span class="token punctuation">)</span>        <span class="token comment">// 指定日志文件路径</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	host<span class="token punctuation">,</span> port <span class="token operator">:=</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"4000"</span>   <span class="token comment">// 指定地址和端口号</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	ctx<span class="token punctuation">,</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token string">"Log Service"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		host<span class="token punctuation">,</span> port<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		log<span class="token punctuation">.</span>RegisterHandlers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre> </pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		stdlog<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre> </pre></td></tr><tr><td data-num="25"></td><td><pre>	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Shutting down log service."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这段代码作为入口，启动这个服务</p><p>当取消函数 (cancel) 被调用后，ctx.Done 就不会被阻塞，往下执行完整个程序</p><h4 id="测试日志服务"><a class="anchor" href="#测试日志服务">#</a> 测试日志服务</h4><p>使用 Postman 发出 POST 请求用于测试，如下所示:</p><p><img data-src="/2022/10/04/computer-science/Simple-distributed/image-20220822193149828.png" title="这是一张图片"></p><p><img data-src="Simple-distributed/image-20220822193149828.png" alt=""></p><p>发送请求后，查看日志文件:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ <span class="token function">cat</span> distributed.log </pre></td></tr><tr><td data-num="2"></td><td><pre>go <span class="token number">2022</span>/08/22 <span class="token number">19</span>:34:08 just <span class="token keyword">for</span> <span class="token builtin class-name">test</span></pre></td></tr></table></figure><p>日志被记录了下来</p><h3 id="服务注册逻辑"><a class="anchor" href="#服务注册逻辑">#</a> 服务注册逻辑</h3><p>下面才正式实现注册中心服务注册的功能，应当实现服务注册的接口，这样客户端能够通过这个接口</p><p>创建 registry 文件夹，编写如下的 registration.go 文件:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> registry</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">type</span> Registration <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	ServiceName ServiceName</pre></td></tr><tr><td data-num="5"></td><td><pre>	ServiceURL  <span class="token builtin">string</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">type</span> ServiceName <span class="token builtin">string</span></pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	LogService <span class="token operator">=</span> <span class="token function">ServiceName</span><span class="token punctuation">(</span><span class="token string">"LogService"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><p>如上定义的 Registration 结构体代表被注册的服务，将目前存在服务定义为常量，目前只有一个日志服务 LogService</p><p>在这个文件夹下再编写一个 server.go，包含服务注册的主要逻辑:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> registry</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"encoding/json"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"log"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"sync"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">const</span> ServerPort <span class="token operator">=</span> <span class="token string">":3000"</span>  <span class="token comment">// 端口</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">const</span> ServicesURL <span class="token operator">=</span> <span class="token string">"http://localhost"</span> <span class="token operator">+</span> ServerPort <span class="token operator">+</span> <span class="token string">"/services"</span>  <span class="token comment">// 查询服务的 URL</span></pre></td></tr><tr><td data-num="12"></td><td><pre> </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">type</span> registry <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	registrations <span class="token punctuation">[</span><span class="token punctuation">]</span>Registration  <span class="token comment">// 切片</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	mutex         <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex     <span class="token comment">// 互斥锁</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre> </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>reg Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	r<span class="token punctuation">.</span>registrations <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>registrations<span class="token punctuation">,</span> reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">return</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre> </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">var</span> reg <span class="token operator">=</span> registry<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	registrations<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Registration<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	mutex<span class="token punctuation">:</span>         <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre> </pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">type</span> Service <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> </pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>s Service<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Request received"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token keyword">switch</span> r<span class="token punctuation">.</span>Method <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token keyword">case</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		dec <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token keyword">var</span> r Registration</pre></td></tr><tr><td data-num="38"></td><td><pre>		err <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Adding service: %v with URL: %s\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ServiceURL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		err <span class="token operator">=</span> reg<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token keyword">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义了一个结构体 registry，包含了两个成员：一个切片，可以看成是一系列服务的集合，和一个互斥锁，用于并发控制，之后将其创建</p><p>随后定义的 add 函数作用是注册，在上锁的情况下向集合添加元素，接着定义 ServeHTTP 函数，只接收 POST 请求，解析 JSON 数据，将其中服务名称通过 add 函数添加到上述创建的 Registration 结构中的集合中，这就意味着成功注册了一个服务</p><h3 id="独立运行服务注册"><a class="anchor" href="#独立运行服务注册">#</a> 独立运行服务注册</h3><p>将上述编写的服务注册的程序独立运行起来，将启动日志服务的 main.go 单独丢进一个 cmd 下的 logservice 文件夹，在 cmd 下创建一个 registryservice 文件夹，编写对应的 main.go 文件:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> main</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"context"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"distributed/registry"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"log"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/services"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>registry<span class="token punctuation">.</span>Service<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre> </pre></td></tr><tr><td data-num="14"></td><td><pre>	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre> </pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">var</span> srv http<span class="token punctuation">.</span>Server</pre></td></tr><tr><td data-num="18"></td><td><pre>	srv<span class="token punctuation">.</span>Addr <span class="token operator">=</span> registry<span class="token punctuation">.</span>ServerPort</pre></td></tr><tr><td data-num="19"></td><td><pre> </pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token keyword">var</span> s <span class="token builtin">string</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Scanln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre> </pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Shutting down registry service"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这段代码的作用就是将服务注册程序给运行起来，registry.Service 已经实现了 ServeHTTP 接口方法，因此可以直接将这个结构体变量传给 http.Handle 函数</p><p>这段代码与上述 service.go 有点相似，在用户输入任意字符后中止掉程序</p><h3 id="注册一个服务"><a class="anchor" href="#注册一个服务">#</a> 注册一个服务</h3><p>封装一个函数向服务端发送 POST 请求来注册一个服务，在 registry 下编写一个 client.go 文件:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> registry</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"bytes"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"encoding/json"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">func</span> <span class="token function">RegisterService</span><span class="token punctuation">(</span>r Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	buf <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	enc <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>ServicesURL<span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre> </pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to register service. Registry service "</span><span class="token operator">+</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token string">"responded with code %v"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token keyword">return</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上述代码中定义了一个 RegisterService 函数，向 URL 发送 POST 请求来注册服务，请求中包括了服务名称和服务的 URL</p><p>接下来要修改之前的代码，因为发送的数据是 Registration 结构体类型的数据，而上述编写的服务注册的服务端须要更改参数类型，修改 service/service.go 文件，这里在 Start 函数中加上 Registration 结构体类型的参数，serviceName 这个参数可以删掉，并且启动这个服务时应该进行注册，所以在该函数中加上 RegisterService 函数:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token builtin">string</span><span class="token punctuation">,</span> reg registry<span class="token punctuation">.</span>Registration<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	registerHandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token function">registerHandlerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	ctx <span class="token operator">=</span> <span class="token function">startService</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> reg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	err <span class="token operator">:=</span> registry<span class="token punctuation">.</span><span class="token function">RegisterService</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span>  <span class="token comment">// 注册服务</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token keyword">return</span> ctx<span class="token punctuation">,</span> err</pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">return</span> ctx<span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同时一并修改 startService 函数的参数:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">startService</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> serviceName registry<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token builtin">string</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">var</span> srv http<span class="token punctuation">.</span>Server</pre></td></tr><tr><td data-num="4"></td><td><pre>	srv<span class="token punctuation">.</span>Addr <span class="token operator">=</span> <span class="token string">":"</span> <span class="token operator">+</span> port</pre></td></tr><tr><td data-num="5"></td><td><pre> </pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v started. Press any key to stop. \n"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">var</span> s <span class="token builtin">string</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		fmt<span class="token punctuation">.</span><span class="token function">Scanln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre> </pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">return</span> ctx</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后要修改 logservice 中的 main.go，因为函数已经被修改:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">...</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>serviceAddress <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%s:%s"</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre>r <span class="token operator">:=</span> registry<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    ServiceName<span class="token punctuation">:</span> <span class="token string">"Log Service"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    ServiceURL<span class="token punctuation">:</span>  serviceAddress<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>ctx<span class="token punctuation">,</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token string">"Log Service"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> r<span class="token punctuation">,</span> log<span class="token punctuation">.</span>RegisterHandlers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">...</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>接下来运行这个服务，先启动 registryservice/main.go，启动服务注册的程序，在运行 logservice/main.go，这时会先发送一条 POST 请求到服务注册的程序，这时服务注册程序收到这条请求，其中包含了服务名称和 URL，服务注册程序将其添加到集合，视为注册了这个服务:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">13</span>:40:24 Request received</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">13</span>:40:24 Adding service: Log Service with URL: http://localhost:4000</pre></td></tr></table></figure><p>这时服务注册程序输出已经添加了日志服务</p><h3 id="取消注册服务"><a class="anchor" href="#取消注册服务">#</a> 取消注册服务</h3><p>有增就有减，对应地，有服务注册的功能就应该有取消注册的功能</p><p>在 registry/server.go 中添加 remove 函数，与 add 函数作用相反，作用是从集合中去除掉指定的 url 所在的 registration:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">remove</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> reg<span class="token punctuation">.</span>registrations <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token keyword">if</span> reg<span class="token punctuation">.</span>registrations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ServiceURL <span class="token operator">==</span> url <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>			r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			reg<span class="token punctuation">.</span>registrations <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span>registrations<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>registrations<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token keyword">return</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"service at URL %s not found"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用 for-range 遍历 reg 中的切片，当遇到指定的 URL 时则将其去除</p><p>服务注册中，POST 请求用于注册服务，那么将通过 DELETE 请求来取消服务，所以在 ServeHTTP 函数中添加一个针对 DELETE 请求的分支:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>s Service<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Request received"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">switch</span> r<span class="token punctuation">.</span>Method <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token operator">...</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">case</span> http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		payload<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		url <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Removing servcice at URL: %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		err <span class="token operator">=</span> reg<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个服务端接收到 DELETE 请求后，取出其中 body 的 URL，再调用 remove 函数进行删除</p><p>在 registry/client.go 中添加客户端用来取消服务的函数:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">ShutdownService</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">,</span> ServicesURL<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to deregister service. Registry "</span><span class="token operator">+</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token string">"service responded with code %v"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">return</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用 http.NewRequest 来发送 DELETE 请求</p><p>在 StartService 函数中，当服务停止时，调用该 shutdown 函数向服务端发送 DELETE 请求取消掉这个服务</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">startService</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> serviceName registry<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token builtin">string</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token operator">...</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		err <span class="token operator">:=</span> registry<span class="token punctuation">.</span><span class="token function">ShutdownService</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%s:%s"</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token operator">...</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试:</p><p>先启动服务注册程序，然后再启动日志服务，再按任意键关闭</p><p>日志服务:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Log Service started. Press any key to stop. </pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:44 http: Server closed</pre></td></tr><tr><td data-num="5"></td><td><pre>Shutting down log service.</pre></td></tr></table></figure><p>服务注册程序:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:42 Request received</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:42 Adding service: Log Service with URL: http://localhost:4000</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:44 Request received</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:44 Removing servcice at URL: http://localhost:4000</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:44 Request received</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2022</span>/08/23 <span class="token number">16</span>:45:44 Removing servcice at URL: http://localhost:4000</pre></td></tr></table></figure><h2 id="服务发现"><a class="anchor" href="#服务发现">#</a> 服务发现</h2><p>在此之前，先实现一个业务服务，功能是学生成绩管理，用户可以查询和增加学生的成绩信息</p><h3 id="创建业务服务"><a class="anchor" href="#创建业务服务">#</a> 创建业务服务</h3><p>创建一个 grades 文件夹，编写相关代码，如下是 grades.go 文件，包含了成绩信息管理的主要逻辑:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> grades</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"sync"</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre> </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	ID        <span class="token builtin">int</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	FirstName <span class="token builtin">string</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	LastName  <span class="token builtin">string</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	Grades    <span class="token punctuation">[</span><span class="token punctuation">]</span>Grade</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>s Student<span class="token punctuation">)</span> <span class="token function">Average</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">var</span> result <span class="token builtin">float32</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> grade <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>Grades <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		result <span class="token operator">+=</span> grade<span class="token punctuation">.</span>Score</pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token keyword">return</span> result <span class="token operator">/</span> <span class="token function">float32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Grades<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre> </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">type</span> Students <span class="token punctuation">[</span><span class="token punctuation">]</span>Student</pre></td></tr><tr><td data-num="24"></td><td><pre> </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">var</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	students      Students</pre></td></tr><tr><td data-num="27"></td><td><pre>	studentsMutex sync<span class="token punctuation">.</span>Mutex</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre> </pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>ss Students<span class="token punctuation">)</span> <span class="token function">GetByID</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Student<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ss <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		<span class="token keyword">if</span> ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ID <span class="token operator">==</span> id <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>			<span class="token keyword">return</span> <span class="token operator">&amp;</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"student with ID %d not found"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre> </pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">type</span> GradeType <span class="token builtin">string</span></pre></td></tr><tr><td data-num="40"></td><td><pre> </pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	GradeQuiz <span class="token operator">=</span> <span class="token function">GradeType</span><span class="token punctuation">(</span><span class="token string">"Quiz"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>	GradeTest <span class="token operator">=</span> <span class="token function">GradeType</span><span class="token punctuation">(</span><span class="token string">"Test"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>	GradeExam <span class="token operator">=</span> <span class="token function">GradeType</span><span class="token punctuation">(</span><span class="token string">"Exam"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre> </pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">type</span> Grade <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	Title <span class="token builtin">string</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	Type  GradeType</pre></td></tr><tr><td data-num="50"></td><td><pre>	Score <span class="token builtin">float32</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义了 students 结构体，表示了学生信息:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	ID        <span class="token builtin">int</span>     <span class="token comment">// 学生 ID</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	FirstName <span class="token builtin">string</span>  <span class="token comment">// 名</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	LastName  <span class="token builtin">string</span>  <span class="token comment">// 姓</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	Grades    <span class="token punctuation">[</span><span class="token punctuation">]</span>Grade <span class="token comment">// 成绩</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义了 grade 结构体:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> Grade <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	Title <span class="token builtin">string</span>       <span class="token comment">// 名称</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	Type  GradeType    <span class="token comment">// 类别</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	Score <span class="token builtin">float32</span>      <span class="token comment">// 得分</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>GetByID 用于根据 ID 来查询学生信息，Average 用于求平均成绩</p><p>创建 server.go 文件，作为该服务的后端，之后会被 services 中的 Start 函数调用:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> grades</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"bytes"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"encoding/json"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"log"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token string">"strconv"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token string">"strings"</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre> </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">func</span> <span class="token function">RegisterHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	handler <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>studentsHandler<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/students"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/students/"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre> </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">type</span> studentsHandler <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>sh studentsHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	pathSegments <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token keyword">switch</span> <span class="token function">len</span><span class="token punctuation">(</span>pathSegments<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		sh<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		id<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>pathSegments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		sh<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		id<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>pathSegments<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>			<span class="token keyword">return</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>		sh<span class="token punctuation">.</span><span class="token function">addGrade</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token keyword">default</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre> </pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>sh studentsHandler<span class="token punctuation">)</span> <span class="token function">getAll</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	studentsMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token keyword">defer</span> studentsMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre> </pre></td></tr><tr><td data-num="49"></td><td><pre>	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> sh<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>students<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment">// 写回数据</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre> </pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>sh studentsHandler<span class="token punctuation">)</span> <span class="token function">toJSON</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>	<span class="token keyword">var</span> b bytes<span class="token punctuation">.</span>Buffer</pre></td></tr><tr><td data-num="61"></td><td><pre>	enc <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>	err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to serialize students: %q"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre> </pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>sh studentsHandler<span class="token punctuation">)</span> <span class="token function">getOne</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>	studentsMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>	<span class="token keyword">defer</span> studentsMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre> </pre></td></tr><tr><td data-num="73"></td><td><pre>	student<span class="token punctuation">,</span> err <span class="token operator">:=</span> students<span class="token punctuation">.</span><span class="token function">GetByID</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="78"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre> </pre></td></tr><tr><td data-num="80"></td><td><pre>	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> sh<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Failed to serialize student: %q\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="85"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="87"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre> </pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>sh studentsHandler<span class="token punctuation">)</span> <span class="token function">addGrade</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>	studentsMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre>	<span class="token keyword">defer</span> studentsMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="93"></td><td><pre> </pre></td></tr><tr><td data-num="94"></td><td><pre>	student<span class="token punctuation">,</span> err <span class="token operator">:=</span> students<span class="token punctuation">.</span><span class="token function">GetByID</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="95"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="97"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="99"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>	<span class="token keyword">var</span> g Grade</pre></td></tr><tr><td data-num="101"></td><td><pre>	dec <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="102"></td><td><pre>	err <span class="token operator">=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="103"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="106"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="107"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>	student<span class="token punctuation">.</span>Grades <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>Grades<span class="token punctuation">,</span> g<span class="token punctuation">)</span>  <span class="token comment">// 添加数据</span></pre></td></tr><tr><td data-num="109"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusCreated<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="110"></td><td><pre>	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> sh<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="113"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="114"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="116"></td><td><pre>	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用 RegisterHandlers 注册 http handler，路径指向 URL 下的 students，会作为 Start 函数的参数</p><p>作为一个服务，同样要为结构体定义一个接口方法 ServeHTTP，该方法要应对 URL 的几种情况:</p><ol><li><code>/students</code> 获得所有学生的成绩</li><li><code>/students/&#123;id&#125;</code> 获得指定 ID 的学生的信息</li><li><code>/students/&#123;id&#125;/grades</code> 获得增加学生的成绩</li></ol><p>使用 string.Split 将 URL 路径切分为多段，使用 switch-case 结构根据分段的个数进行分支处理，段数为 2、3 和 4 分别对应了上述 3 种情况，分别调用 getAll、getOne 和 addGrade 函数，实现细节不再赘述</p><p>这里还要定义一个将结构体序列化为 JSON 数据的函数，接收一个空接口:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>sh studentsHandler<span class="token punctuation">)</span> <span class="token function">toJSON</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">var</span> b bytes<span class="token punctuation">.</span>Buffer</pre></td></tr><tr><td data-num="3"></td><td><pre>	enc <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to serialize students: %q"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>编写一个 mockdata.go 文件，制造一些数据:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> grades</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	students <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Student<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			ID<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			FirstName<span class="token punctuation">:</span> <span class="token string">"Nick"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			LastName<span class="token punctuation">:</span>  <span class="token string">"Carter"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			Grades<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Grade<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>					<span class="token string">"Quiz 1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>					GradeQuiz<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>					<span class="token number">85</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>					<span class="token string">"Final Exam"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>					GradeExam<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>					<span class="token number">94</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>					<span class="token string">"Quiz 2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>					GradeQuiz<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>					<span class="token number">97</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			ID<span class="token punctuation">:</span>        <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>			FirstName<span class="token punctuation">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>			LastName<span class="token punctuation">:</span>  <span class="token string">"Bright"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			Grades<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Grade<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>					<span class="token string">"Final Exam"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>					GradeExam<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>					<span class="token number">100</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>					<span class="token string">"Quiz 2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>					GradeQuiz<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>					<span class="token number">80</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>				<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>					<span class="token string">"Test 1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>					GradeTest<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>					<span class="token number">99</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这样一个业务服务就完成了，添加到 registry/registrantion.go 中:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	LogService     <span class="token operator">=</span> <span class="token function">ServiceName</span><span class="token punctuation">(</span><span class="token string">"LogService"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	GradingService <span class="token operator">=</span> <span class="token function">ServiceName</span><span class="token punctuation">(</span><span class="token string">"GradingService"</span><span class="token punctuation">)</span>  <span class="token comment">// 业务服务</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">)</span></pre></td></tr></table></figure><p>和日志服务相似，创建 cmd/gradingservice/main.go 文件，编写启动代码:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> main</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"context"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"distributed/log"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"distributed/registry"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token string">"distributed/service"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	stdlog <span class="token string">"log"</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre> </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	log<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"./distributed.log"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	host<span class="token punctuation">,</span> port <span class="token operator">:=</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"6000"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	serviceAddress <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%s:%s"</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre> </pre></td></tr><tr><td data-num="17"></td><td><pre>	r <span class="token operator">:=</span> registry<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		ServiceName<span class="token punctuation">:</span> registry<span class="token punctuation">.</span>GradingService<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		ServiceURL<span class="token punctuation">:</span>  serviceAddress<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	ctx<span class="token punctuation">,</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> r<span class="token punctuation">,</span> log<span class="token punctuation">.</span>RegisterHandlers<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre> </pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		stdlog<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre> </pre></td></tr><tr><td data-num="30"></td><td><pre>	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Shutting down grading service."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>服务注册到这里就基本实现了，如下是项目结构:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>├── cmd</pre></td></tr><tr><td data-num="3"></td><td><pre>│   ├── gradingservice</pre></td></tr><tr><td data-num="4"></td><td><pre>│   │   └── main.go</pre></td></tr><tr><td data-num="5"></td><td><pre>│   ├── logservice</pre></td></tr><tr><td data-num="6"></td><td><pre>│   │   └── main.go</pre></td></tr><tr><td data-num="7"></td><td><pre>│   └── registryservice</pre></td></tr><tr><td data-num="8"></td><td><pre>│       └── main.go</pre></td></tr><tr><td data-num="9"></td><td><pre>├── log</pre></td></tr><tr><td data-num="10"></td><td><pre>│   └── server.go</pre></td></tr><tr><td data-num="11"></td><td><pre>├── registry</pre></td></tr><tr><td data-num="12"></td><td><pre>│   ├── client.go</pre></td></tr><tr><td data-num="13"></td><td><pre>│   ├── registration.go</pre></td></tr><tr><td data-num="14"></td><td><pre>│   └── server.go</pre></td></tr><tr><td data-num="15"></td><td><pre>└── <span class="token function">service</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    └── service.go</pre></td></tr></table></figure><h3 id="实现服务发现"><a class="anchor" href="#实现服务发现">#</a> 实现服务发现</h3><p>完成了上述的业务服务 gradingservice 后，要使其能够请求 logservice</p><p>接下来编辑 registry/registration.go 文件，扩展 Registration 结构体:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> Registration <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	ServiceName      ServiceName</pre></td></tr><tr><td data-num="3"></td><td><pre>	ServiceURL       <span class="token builtin">string</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	RequiredServices <span class="token punctuation">[</span><span class="token punctuation">]</span>ServiceName</pre></td></tr><tr><td data-num="5"></td><td><pre>	ServiceUpdateURL <span class="token builtin">string</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>RequiredServices 表示了该服务所依赖的服务名称，ServiceUpdateURL 用于动态接收更新，比如注册中心就通过这个 URL 告诉这个服务，这里有一个 logservice</p><p>创建两个结构体:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> patchEntry <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	Name ServiceName</pre></td></tr><tr><td data-num="3"></td><td><pre>	URL  <span class="token builtin">string</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该结构体表示单条更新条目</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> patch <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	Added   <span class="token punctuation">[</span><span class="token punctuation">]</span>patchEntry</pre></td></tr><tr><td data-num="3"></td><td><pre>	Removed <span class="token punctuation">[</span><span class="token punctuation">]</span>patchEntry</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该结构体记录增加和减少的条目</p><p>编写 registry/server.go，扩展注册中心的后端，先扩展 add 函数，在添加服务时就添加为其依赖服务:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>reg Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	r<span class="token punctuation">.</span>registrations <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>registrations<span class="token punctuation">,</span> reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">sendRequiredServices</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">return</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>调用了一个 sendRequiredServices 函数，功能是添加依赖，发送一个请求，将所要依赖的服务给请求过来，方法实现如下:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">sendRequiredServices</span><span class="token punctuation">(</span>reg Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">defer</span> r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> </pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">var</span> p patch</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> serviceReg <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>registrations <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reqService <span class="token operator">:=</span> <span class="token keyword">range</span> reg<span class="token punctuation">.</span>RequiredServices <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token keyword">if</span> serviceReg<span class="token punctuation">.</span>ServiceName <span class="token operator">==</span> reqService <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>				p<span class="token punctuation">.</span>Added <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Added<span class="token punctuation">,</span> patchEntry<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>					Name<span class="token punctuation">:</span> serviceReg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>					URL<span class="token punctuation">:</span>  serviceReg<span class="token punctuation">.</span>ServiceURL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">sendPatch</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> reg<span class="token punctuation">.</span>ServiceUpdateURL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上述函数中，循环遍历已经注册的服务，如果找到所依赖的服务，则添加到切片里，稍后调用 sendPatch 发送出去，实现如下:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">sendPatch</span><span class="token punctuation">(</span>p patch<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	d<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该函数先将 patch 结构序列化为一个 JSON 数据，然后放在 POST 请求中发送</p><p>每个客户端的服务都有所依赖的服务，要向注册中心请求这些服务，得存储这些请求的服务，比如 gradingservice 就要依赖 logservice</p><p>定义一个结构 providers:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> providers <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	services <span class="token keyword">map</span><span class="token punctuation">[</span>ServiceName<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	mutex    <span class="token operator">*</span>sync<span class="token punctuation">.</span>RWMutex</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中储存了服务的提供者，定义了一个 map 结构，和一个读写锁</p><p>初始化这个结构体变量:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> prov <span class="token operator">=</span> providers<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	services<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>ServiceName<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	mutex<span class="token punctuation">:</span>    <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>RWMutex<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义对于的更新方法，用于更新这个结构中的数据:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>providers<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>pat patch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	p<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre> </pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> patchEntry <span class="token operator">:=</span> <span class="token keyword">range</span> pat<span class="token punctuation">.</span>Added <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>patchEntry<span class="token punctuation">.</span>Name<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>patchEntry<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>patchEntry<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>patchEntry<span class="token punctuation">.</span>Name<span class="token punctuation">]</span><span class="token punctuation">,</span> patchEntry<span class="token punctuation">.</span>URL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> patchEntry <span class="token operator">:=</span> <span class="token keyword">range</span> pat<span class="token punctuation">.</span>Removed <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token keyword">if</span> providerURLs<span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>patchEntry<span class="token punctuation">.</span>Name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> providerURLs <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>				<span class="token keyword">if</span> providerURLs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> patchEntry<span class="token punctuation">.</span>URL <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>					p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>patchEntry<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>providerURLs<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> providerURLs<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>先遍历 Added，也就是 patch 要增加的服务，如果 added 里的服务在 providers 中还不存在，则创建这个 service，然后将这个服务和对应 URL 写入 map，同理，接着遍历 Removed，已有的服务就将其删除</p><p>接着定义了一个 get 函数，通过服务名称找到对应的 URL:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>providers<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>name ServiceName<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	providers<span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>services<span class="token punctuation">[</span>name<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"no providers avaliable for service %v"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	idx <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Float32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">float32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">return</span> providers<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">func</span> <span class="token function">GetProvider</span><span class="token punctuation">(</span>name ServiceName<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">return</span> prov<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>目前 providers 只有 logservice</p><p>接着再将 ServiceUpdateURL 绑定到一个 handler 上，从而能够对其进行处理:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">RegisterService</span><span class="token punctuation">(</span>r Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	serviceUpdateURL<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>ServiceUpdateURL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>serviceUpdateURL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>serviceUpdateHandler<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token operator">...</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>定义接口方法:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> serviceUpdateHandler <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>suh serviceUpdateHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">!=</span> http<span class="token punctuation">.</span>MethodPost <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token keyword">return</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	dec <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">var</span> p patch</pre></td></tr><tr><td data-num="10"></td><td><pre>	err <span class="token operator">:=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadGateway<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	prov<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>ServeHTTP 中接收 POST 请求，将 Body 到数据反序列化后传入 Update 方法再调用</p><p>因为经过了一些扩展，所以要修改 Registration，增加所要依赖的服务和 URL 字段</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> Registration <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	ServiceName      ServiceName</pre></td></tr><tr><td data-num="3"></td><td><pre>	ServiceURL       <span class="token builtin">string</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	RequiredServices <span class="token punctuation">[</span><span class="token punctuation">]</span>ServiceName</pre></td></tr><tr><td data-num="5"></td><td><pre>	ServiceUpdateURL <span class="token builtin">string</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>下面优化一下 logservice，目前日志服务只有一个服务端，要让客户端能够方便地使用提供的 logservice 服务，在 log 下再编写一个 client.go 文件:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> log</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token string">"bytes"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token string">"distributed/registry"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token string">"fmt"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	stdlog <span class="token string">"log"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token string">"net/http"</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">func</span> <span class="token function">SetClientLogger</span><span class="token punctuation">(</span>serviceURL <span class="token builtin">string</span><span class="token punctuation">,</span> clientService registry<span class="token punctuation">.</span>ServiceName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	stdlog<span class="token punctuation">.</span><span class="token function">SetPrefix</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"[%v] - "</span><span class="token punctuation">,</span> clientService<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	stdlog<span class="token punctuation">.</span><span class="token function">SetFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 不设置 flag</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	stdlog<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>clientLogger<span class="token punctuation">&#123;</span>serviceURL<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre> </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">type</span> clientLogger <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	url <span class="token builtin">string</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>cl clientLogger<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	b <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>cl<span class="token punctuation">.</span>url<span class="token operator">+</span><span class="token string">"/log"</span><span class="token punctuation">,</span> <span class="token string">"text/plain"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err</pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to send log message. "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>SetClientLogger 负责设置客户端日志打印的相关的属性，因为要为 clientLogger 实现 io.Writer 接口，所以下面为其实现一个 Write 方法</p><p>扩展 gradingservice/main.go 中结构体的定义:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre>r <span class="token operator">:=</span> registry<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    ServiceName<span class="token punctuation">:</span>      registry<span class="token punctuation">.</span>GradingService<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    ServiceURL<span class="token punctuation">:</span>       serviceAddress<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    RequiredServices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>registry<span class="token punctuation">.</span>ServiceName<span class="token punctuation">&#123;</span>registry<span class="token punctuation">.</span>LogService<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    ServiceUpdateURL<span class="token punctuation">:</span> serviceAddress <span class="token operator">+</span> <span class="token string">"/services"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>logservice 同时接着还要获取 Provider，即获取提供日志的服务的名称，这便是服务发现</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> logProvider<span class="token punctuation">,</span> err <span class="token operator">:=</span> registry<span class="token punctuation">.</span><span class="token function">GetProvider</span><span class="token punctuation">(</span>registry<span class="token punctuation">.</span>LogService<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Logging service found at: %s\n"</span><span class="token punctuation">,</span> logProvider<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    log<span class="token punctuation">.</span><span class="token function">SetClientLogger</span><span class="token punctuation">(</span>logProvider<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ServiceName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行测试:</p><p>先运行注册中心</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">13</span>:03:05 Request received</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">13</span>:03:05 Adding service: LogService with URL: http://localhost:4000</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">13</span>:03:21 Request received</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">13</span>:03:21 Adding service: GradingService with URL: http://localhost:6000</pre></td></tr></table></figure><p>运行日志服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>LogService started. Press any key to stop.</pre></td></tr></table></figure><p>运行 gradding 服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GradingService started. Press any key to stop. </pre></td></tr><tr><td data-num="3"></td><td><pre>Logging <span class="token function">service</span> found at: http://localhost:4000</pre></td></tr></table></figure><h3 id="服务更新"><a class="anchor" href="#服务更新">#</a> 服务更新</h3><p>对于一个服务，当所依赖的服务发生变化时，应当发出通知，例如 logservice，当这个服务停止时，应该发出一条通知来告知 gradingservice，启动时也应当发出一条通知，在上面的实现中，gradingservice 只能在启动时发现 logservice，并且 logservice 要先于 gradingservice 启动</p><p>在服务启动时就应该进行通知，所以在 add 函数中添加一个通知函数:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>reg Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token operator">...</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">sendRequiredServices</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	r<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>patch<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		Added<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>patchEntry<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>				Name<span class="token punctuation">:</span> reg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>				URL<span class="token punctuation">:</span>  reg<span class="token punctuation">.</span>ServiceURL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通知函数的实现:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">notify</span><span class="token punctuation">(</span>fullPatch patch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">defer</span> r<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reg <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>registrations <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>reg Registration<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reqService <span class="token operator">:=</span> <span class="token keyword">range</span> reg<span class="token punctuation">.</span>RequiredServices <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>				p <span class="token operator">:=</span> patch<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>					Added<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span>patchEntry<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>					Removed<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>patchEntry<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>				sendUpdate <span class="token operator">:=</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="13"></td><td><pre>				<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> added <span class="token operator">:=</span> <span class="token keyword">range</span> fullPatch<span class="token punctuation">.</span>Added <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>					<span class="token keyword">if</span> added<span class="token punctuation">.</span>Name <span class="token operator">==</span> reqService <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>						p<span class="token punctuation">.</span>Added <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Added<span class="token punctuation">,</span> added<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>						sendUpdate <span class="token operator">=</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="17"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>				<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> removed <span class="token operator">:=</span> <span class="token keyword">range</span> fullPatch<span class="token punctuation">.</span>Removed <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>					<span class="token keyword">if</span> removed<span class="token punctuation">.</span>Name <span class="token operator">==</span> reqService <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>						p<span class="token punctuation">.</span>Removed <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Removed<span class="token punctuation">,</span> removed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>						sendUpdate <span class="token operator">=</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="23"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>				<span class="token keyword">if</span> sendUpdate <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>					err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">sendPatch</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> reg<span class="token punctuation">.</span>ServiceUpdateURL<span class="token punctuation">)</span>  <span class="token comment">// 发送 patch</span></pre></td></tr><tr><td data-num="27"></td><td><pre>					<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>						log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>						<span class="token keyword">return</span></pre></td></tr><tr><td data-num="30"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个 notify 函数接收一个 patch 变量作为参数，其中包含的 added 和 removed，对应增加和移除的服务，函数体中要做的事就是先遍历所有的服务，然后遍历其所有的依赖服务，根据传入的 fullPatch 和 added 和 removed，如果依赖服务是要增加或移除的，则将 sendUpdate 标志设置为 true，产生 patch 并发送，进行更新，这些流程使用 goroutine 来并发地进行</p><p>在 registry/client.go 的 ServeHTTP 函数中增加一句提示信息，表示接收到了更新:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>suh serviceUpdateHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token operator">...</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Updated received %v\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	prov<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>对 remove 函数同样要进行扩展:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">remove</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> reg<span class="token punctuation">.</span>registrations <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token keyword">if</span> reg<span class="token punctuation">.</span>registrations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ServiceURL <span class="token operator">==</span> url <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>			r<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>patch<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>				Removed<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>patchEntry<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>					<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>						Name<span class="token punctuation">:</span> r<span class="token punctuation">.</span>registrations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>						URL<span class="token punctuation">:</span>  r<span class="token punctuation">.</span>registrations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ServiceURL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>					<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token operator">...</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"service at URL %s not found"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行测试：先运行注册中心，然后运行 logservice，然后运行 gradingservice，之后关闭 logservice 再启动</p><p>注册中心:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:45 Request received</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:45 Adding service: LogService with URL: http://localhost:4000</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:50 Request received</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:50 Adding service: GradingService with URL: http://localhost:6000</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:53 Request received</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:53 Removing servcice at URL: http://localhost:4000</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:53 Request received</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:53 Removing servcice at URL: http://localhost:4000</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:04:12 Request received</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:04:12 Adding service: LogService with URL: http://localhost:4000</pre></td></tr></table></figure><p>日志服务:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>LogService started. Press any key to stop. </pre></td></tr><tr><td data-num="3"></td><td><pre>Updated received <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">18</span>:03:53 http: Server closed</pre></td></tr><tr><td data-num="6"></td><td><pre>Shutting down log service.</pre></td></tr><tr><td data-num="7"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>LogService started. Press any key to stop. </pre></td></tr><tr><td data-num="9"></td><td><pre>Updated received <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>grading 服务:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ go run <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GradingService started. Press any key to stop. </pre></td></tr><tr><td data-num="3"></td><td><pre>Updated received <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>LogService http://localhost:4000<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>Logging <span class="token function">service</span> found at: http://localhost:4000</pre></td></tr><tr><td data-num="5"></td><td><pre>Updated received <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>LogService http://localhost:4000<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>Updated received <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>LogService http://localhost:4000<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="服务状态监控"><a class="anchor" href="#服务状态监控">#</a> 服务状态监控</h2><p>检查所有服务的健康状况，方法是发送心跳请求，得知服务是否能正常响应</p><p>在 Registration 中加一条 HeartbeatURL:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">type</span> Registration <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	ServiceName      ServiceName</pre></td></tr><tr><td data-num="3"></td><td><pre>	ServiceURL       <span class="token builtin">string</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	RequiredServices <span class="token punctuation">[</span><span class="token punctuation">]</span>ServiceName</pre></td></tr><tr><td data-num="5"></td><td><pre>	ServiceUpdateURL <span class="token builtin">string</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	HeartbeatURL     <span class="token builtin">string</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>增加心跳检查函数:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span>freq time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup</pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> reg <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>registrations <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>			wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>reg Registration<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>				<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>				success <span class="token operator">:=</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>				<span class="token keyword">for</span> attemps <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> attemps <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> attemps<span class="token operator">++</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>					res<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span>HeartbeatURL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>					<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>						log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>					<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> res<span class="token punctuation">.</span>StatusCode <span class="token operator">==</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>						log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Heartbeat check passed for %v"</span><span class="token punctuation">,</span> reg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>						<span class="token keyword">if</span> <span class="token operator">!</span>success <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>							r<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>						<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>						<span class="token keyword">break</span></pre></td></tr><tr><td data-num="19"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>					log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Heartbeat check failed for %v"</span><span class="token punctuation">,</span> reg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>					<span class="token keyword">if</span> success <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>						success <span class="token operator">=</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="23"></td><td><pre>						r<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span>ServiceURL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>					<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>				<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>			<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>			wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>freq<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上述代码中用到了 waitgroup 和 goroutine，对每个服务的 HeartbeatURL 间隔 freq 的时间发起 get 请求，连续发送三次，如果有一次失败 (状态码不等于 200)，那么 success 为 false，那么会调用 remove 来移除服务，如果 success 为 false 又得到了正常的相应，那么又会调用 add 将服务加回来</p><p>上述这段代码将会在如下函数中调用，将其定义在 registry/server.go 中，每隔 3 秒检查一次服务健康状况:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once</pre></td></tr><tr><td data-num="2"></td><td><pre> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">func</span> <span class="token function">SetupRegistryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token keyword">go</span> reg<span class="token punctuation">.</span><span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>与此同时，所有的客户端都应该知道如何相应这种心跳请求:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">func</span> <span class="token function">RegisterService</span><span class="token punctuation">(</span>r Registration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	heartbeatURL<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>HeartbeatURL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>		<span class="token keyword">return</span> err</pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span>heartbeatURL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token operator">...</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在服务注册时，就在心跳 URL 注册一个 handler，处理心跳请求，最后为 logservice 和 gradingservice 都加上心跳 URL:</p><figure class="highlight go"><figcaption data-lang="go"></figcaption><table><tr><td data-num="1"></td><td><pre>r <span class="token operator">:=</span> registry<span class="token punctuation">.</span>Registration<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    ServiceName<span class="token punctuation">:</span>      registry<span class="token punctuation">.</span>LogService<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    ServiceURL<span class="token punctuation">:</span>       serviceAddress<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    RequiredServices<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>registry<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    ServiceUpdateURL<span class="token punctuation">:</span> serviceAddress <span class="token operator">+</span> <span class="token string">"/services"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    HeartbeatURL<span class="token punctuation">:</span>     serviceAddress <span class="token operator">+</span> <span class="token string">"/heartbeat"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>测试</p><p>启动注册中心和两个服务，中途关掉 logservice</p><p>注册中心的输出:</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:24 Adding service: LogService with URL: http://localhost:4000</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:24 Heartbeat check passed <span class="token keyword">for</span> LogService</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:26 Request received</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:26 Adding service: GradingService with URL: http://localhost:6000</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:27 Heartbeat check passed <span class="token keyword">for</span> LogService</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:30 Heartbeat check passed <span class="token keyword">for</span> GradingService</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:33 Heartbeat check passed <span class="token keyword">for</span> LogService</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:36 Heartbeat check passed <span class="token keyword">for</span> GradingService</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:36 Request received</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:36 Removing servcice at URL: http://localhost:4000</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:36 Request received</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:36 Removing servcice at URL: http://localhost:4000</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:39 Heartbeat check passed <span class="token keyword">for</span> GradingService</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:42 Heartbeat check passed <span class="token keyword">for</span> GradingService</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token number">2022</span>/08/24 <span class="token number">19</span>:12:45 Heartbeat check passed <span class="token keyword">for</span> GradingService</pre></td></tr></table></figure><div class="tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="ic i-tag"></i> 分布式系统</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-07-01 11:05:47" itemprop="dateModified" datetime="2023-07-01T11:05:47+08:00">2023-07-01</time> </span><span id="2022/10/04/computer-science/Simple-distributed/" class="item leancloud_visitors" data-flag-title="Simple_distributed" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Caleb <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://hdqjl317.github.io/2022/10/04/computer-science/Simple-distributed/" title="Simple_distributed">https://hdqjl317.github.io/2022/10/04/computer-science/Simple-distributed/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/08/20/worktech/vscode%E9%80%9A%E8%BF%87%E5%AF%86%E9%92%A5%E8%BF%9E%E6%8E%A5%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="prev" data-background-image="&#x2F;2022&#x2F;08&#x2F;20&#x2F;worktech&#x2F;vscode%E9%80%9A%E8%BF%87%E5%AF%86%E9%92%A5%E8%BF%9E%E6%8E%A5%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8&#x2F;assets&#x2F;yclj.jpg" title="vscode通过密钥连接远程服务器"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 工作技能</span><h3>vscode通过密钥连接远程服务器</h3></a></div><div class="item right"><a href="/2023/02/03/computer-science/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" itemprop="url" rel="next" data-background-image="&#x2F;2023&#x2F;02&#x2F;03&#x2F;computer-science&#x2F;%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86&#x2F;assets&#x2F;byyl.jpg" title="编译原理"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 计算机科学</span><h3>编译原理</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.</span> <span class="toc-text">服务注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">创建日志服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.1.</span> <span class="toc-text">编写日志服务逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.2.</span> <span class="toc-text">运行日志服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.3.</span> <span class="toc-text">测试日志服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E9%80%BB%E8%BE%91"><span class="toc-number">1.2.</span> <span class="toc-text">服务注册逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.</span> <span class="toc-text">独立运行服务注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">注册一个服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">取消注册服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">创建业务服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">实现服务发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9B%B4%E6%96%B0"><span class="toc-number">2.3.</span> <span class="toc-text">服务更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="toc-number">3.</span> <span class="toc-text">服务状态监控</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2022/10/04/computer-science/Simple-distributed/" rel="bookmark" title="Simple_distributed">Simple_distributed</a></li><li><a href="/2023/02/03/computer-science/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="bookmark" title="编译原理">编译原理</a></li><li><a href="/2023/03/08/computer-science/Rust%E8%BF%87%E7%A8%8B%E5%AE%8F/" rel="bookmark" title="Rust过程宏">Rust过程宏</a></li><li><a href="/2023/03/08/computer-science/Rust%E5%AE%8F/" rel="bookmark" title="Rust宏">Rust宏</a></li><li><a href="/2023/03/12/computer-science/RISCV%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" rel="bookmark" title="RISCV汇编代码分析">RISCV汇编代码分析</a></li><li><a href="/2023/03/22/computer-science/start-kernel%E5%88%86%E6%9E%90/" rel="bookmark" title="start_kernel分析">start_kernel分析</a></li><li><a href="/2023/03/26/computer-science/Rust%E5%A3%B0%E6%98%8E%E5%AE%8F%E4%B8%8E%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" rel="bookmark" title="Rust声明宏与条件编译">Rust声明宏与条件编译</a></li><li><a href="/2023/03/26/computer-science/Rust%E5%A3%B0%E6%98%8E%E5%AE%8F%E4%B8%8A%E4%B8%8B%E6%96%87%E6%97%A0%E5%85%B3%E6%96%87%E6%B3%95/" rel="bookmark" title="Rust声明宏上下文无关文法">Rust声明宏上下文无关文法</a></li><li><a href="/2023/03/29/computer-science/%E4%BB%A5time-gettimeofday%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%BA%E4%BE%8B%E5%88%86%E6%9E%90ARM64-Linux5-4-34/" rel="bookmark" title="以time/gettimeofday系统调用为例分析ARM64-Linux5.4.34">以time/gettimeofday系统调用为例分析ARM64-Linux5.4.34</a></li><li><a href="/2023/04/02/computer-science/Rust%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" rel="bookmark" title="Rust条件编译">Rust条件编译</a></li><li><a href="/2023/04/02/computer-science/Rust%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BE%8B%E5%AD%90/" rel="bookmark" title="Rust声明宏的一些例子">Rust声明宏的一些例子</a></li><li><a href="/2023/04/25/computer-science/c2rust%E5%AE%8F%E6%8C%87%E4%BB%A4%E8%BD%AC%E5%8C%96%E8%A7%84%E5%88%991/" rel="bookmark" title="c2rust宏指令转化规则1">c2rust宏指令转化规则1</a></li><li><a href="/2023/04/25/computer-science/c2rust%E5%AE%8F%E6%8C%87%E4%BB%A4%E8%BD%AC%E5%8C%96%E8%A7%84%E5%88%992/" rel="bookmark" title="c2rust宏指令转化规则2">c2rust宏指令转化规则2</a></li><li><a href="/2023/04/25/computer-science/Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2/" rel="bookmark" title="Linux操作系统深入理解进程切换">Linux操作系统深入理解进程切换</a></li><li><a href="/2023/06/30/computer-science/C%E5%AE%8F%E5%88%B0Rust%E5%AE%8F%E8%BD%AC%E5%8C%96%E8%A7%84%E5%88%99%E8%AE%BE%E8%AE%A1/" rel="bookmark" title="C宏到Rust宏转化规则设计">C宏到Rust宏转化规则设计</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Caleb" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Caleb</p><div class="description" itemprop="description">欢迎来到 Caleb 的个人博客!</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">20</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">8</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hEcWpsMzE3" title="https:&#x2F;&#x2F;github.com&#x2F;HDqjl317"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOmppYWxlX3F1YW5AdXN0Yy5lZHU=" title="mailto:jiale_quan@ustc.edu"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/08/20/worktech/vscode%E9%80%9A%E8%BF%87%E5%AF%86%E9%92%A5%E8%BF%9E%E6%8E%A5%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/02/03/computer-science/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/codelanguage/" title="分类于 编程语言">编程语言</a></div><span><a href="/2022/08/04/codelanguage/cpp11%E6%96%B0%E7%89%B9%E6%80%A7%E7%AF%872/" title="cpp11新特性篇2">cpp11新特性篇2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/03/08/computer-science/Rust%E5%AE%8F/" title="Rust宏">Rust宏</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/04/02/computer-science/Rust%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" title="Rust条件编译">Rust条件编译</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/03/29/computer-science/%E4%BB%A5time-gettimeofday%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%BA%E4%BE%8B%E5%88%86%E6%9E%90ARM64-Linux5-4-34/" title="以time&#x2F;gettimeofday系统调用为例分析ARM64-Linux5.4.34">以time/gettimeofday系统调用为例分析ARM64-Linux5.4.34</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/03/26/computer-science/Rust%E5%A3%B0%E6%98%8E%E5%AE%8F%E4%B8%8E%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" title="Rust声明宏与条件编译">Rust声明宏与条件编译</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/06/30/computer-science/C%E5%AE%8F%E5%88%B0Rust%E5%AE%8F%E8%BD%AC%E5%8C%96%E8%A7%84%E5%88%99%E8%AE%BE%E8%AE%A1/" title="C宏到Rust宏转化规则设计">C宏到Rust宏转化规则设计</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/03/26/computer-science/Rust%E5%A3%B0%E6%98%8E%E5%AE%8F%E4%B8%8A%E4%B8%8B%E6%96%87%E6%97%A0%E5%85%B3%E6%96%87%E6%B3%95/" title="Rust声明宏上下文无关文法">Rust声明宏上下文无关文法</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/03/08/computer-science/Rust%E8%BF%87%E7%A8%8B%E5%AE%8F/" title="Rust过程宏">Rust过程宏</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2023/03/22/computer-science/start-kernel%E5%88%86%E6%9E%90/" title="start_kernel分析">start_kernel分析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/2022/10/04/computer-science/Simple-distributed/" title="Simple_distributed">Simple_distributed</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Caleb @ Caleb</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">98k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">1:29</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/10/04/computer-science/Simple-distributed/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>